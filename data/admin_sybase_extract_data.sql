SELECT projinv.INVOICE_ID AS PROJECT_INVOICE_ID,
custinv.INVOICE_ID AS CUSTOMER_INVOICE_ID,
custinv.INVOICE_NR,
projinv.INVOICE_DATE,
projinv.COMPANY_ID, 
custinv.CUSTOMER_ID AS BILL_TO_CUSTOMER_ID, 
billcustaddr.SIRET_NUMMER AS BILL_TO_CUSTOMER_SIRET,
sellcust.CUSTOMER_ID AS SELL_TO_CUSTOMER_ID, 
projinv.PROJECT_ID, 
proj.SERVICE_TYPE_ID AS PROJECT_TYPE_ID, 
ptype.DDDW_VALUE AS PROJECT_TYPE_DESCRIPTION, 
invset.INVOICING_TYPE, 
ild.LINE_ORDER, 
ild.LINE_ID, 
ild.LINE_DATE, 
ild.LINE_INVOICED,
ild.LINE_TYPE, 
CASE
    WHEN ild.LINE_TYPE = 1 THEN 'Time registration'
    WHEN ild.LINE_TYPE = 2 THEN 'Non material cost'
    WHEN ild.LINE_TYPE = 3 THEN 'Material cost'
    WHEN ild.LINE_TYPE = 4 THEN 'Advances'
    WHEN ild.LINE_TYPE = 5 THEN 'Taskflow'
    ELSE 'Unknown'
END AS LINE_TYPE_DESCRIPTION,
reg.reg_reg_id AS REG_OBJECT,
reg.reg_reg AS REG_OBJECT_DESCRIPTION,
CASE
    WHEN ild.LINE_TYPE = 1 THEN pres.INVOICED
    ELSE null
END AS REG_OBJECT_INVOICED,
ISNULL(ild.LINE_DESCRIPTION_USER, '') AS REMARK,
ISNULL(LENGTH(ild.LINE_DESCRIPTION_USER), 0) AS REMARK_LENGTH, 
ISNULL(reg.REG_FREETEXT_INTERNAL, '') AS INTERNAL_REMARK,
ISNULL(LENGTH(reg.REG_FREETEXT_INTERNAL), 0) AS INTERNAL_REMARK_LENGTH, 
reg.reg_user_id AS LINE_PERSON_ID,
ild.LINE_PERSON_NAME, 
empfin.CONTRACT_DATE_BEGIN AS LINE_PERSON_CONTRACT_DATE_BEGIN, 
CAST(ild.LINE_TARIFF AS FLOAT),
CAST(ild.LINE_ORIGINAL_QUANTITY AS FLOAT), 
CAST(ild.LINE_QUANTITY AS FLOAT)

FROM DBA.INVOICE projinv
LEFT JOIN DBA.INVOICE_LINES_DETAILS ild ON projinv.INVOICE_ID = ild.INVOICE_ID
LEFT JOIN DBA.V_REGISTRATION_ALL reg ON (ild.LINE_LINKED_ID = reg.REG_ID AND ild.LINE_TYPE = reg.REG_TYPE)
LEFT JOIN DBA.EMPLOYEE_FINANCIAL_DATA empfin ON reg.REG_USER_ID = empfin.PERSON_ID
LEFT JOIN DBA.PRESTATIE pres ON reg.reg_reg_id = pres.PRESTATIE_ID
LEFT JOIN DBA.PROJECT proj ON projinv.PROJECT_ID = proj.PROJECTID
LEFT JOIN DBA.V_PROJECT_INVOICE_SETTINGS invset ON projinv.PROJECT_ID = invset.PROJECT_ID
LEFT JOIN DBA.INVOICE_PROJECT_CUSTOMER invmap ON projinv.INVOICE_ID = invmap.PROJECT_INVOICE_ID
LEFT JOIN DBA.INVOICE custinv ON invmap.CUSTOMER_INVOICE_ID = custinv.INVOICE_ID
LEFT JOIN (
    SELECT PROJECT_ID, CUSTOMER_ID, PERCENTAGE
    FROM DBA.PROJECT_CUSTOMER pc
    WHERE pc.TASKFLOW_CUSTOMER = 1) sellcust ON projinv.PROJECT_ID = sellcust.PROJECT_ID
LEFT JOIN DBA.CUSTOMER billcust ON custinv.CUSTOMER_ID = billcust.CUSTOMER_ID
LEFT JOIN (
    SELECT A.CUSTOMER_ID, B.SIRET_NUMMER
    FROM DBA.CUSTOMER_ADRESS A 
    LEFT JOIN DBA.CUSTOMER_ADRESS_OWN_COMPLEMENT B ON A.CUSTOMER_ADRESS_ID = B.CUSTOMER_ADRESS_ID
    WHERE A.MAAT_ADRESS = 1) billcustaddr ON billcust.CUSTOMER_ID = billcustaddr.CUSTOMER_ID
LEFT JOIN DBA.SYNETON_DYNAMIC_DDDW_VALUES ptype ON proj.SERVICE_TYPE_ID = ptype.DDDW_VALUE_ID

WHERE projinv.FAZE_ID = 31
AND projinv.INVOICE_DATE BETWEEN 'yyyy-MM-dd' AND 'yyyy-MM-dd'
AND ild.LINE_DATE BETWEEN 'yyyy-MM-dd' AND 'yyyy-MM-dd'
AND (projinv.COMPANY_ID = 1 OR projinv.COMPANY_ID = 2)
AND invset.INVOICING_TYPE = 'REGIE'
AND BILL_TO_CUSTOMER_ID NOT IN (7162, 1872, 4537, 4393, 5176, 16141, 16021)
AND custinv.INVOICE_NR IS NOT NULL
AND proj.SERVICE_TYPE_ID > 800

ORDER BY projinv.INVOICE_ID, ild.LINE_ORDER